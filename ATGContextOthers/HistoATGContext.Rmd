---
title: "Start codon context for Histoplasma capsulatum G217B"
author: Edward Wallace, ewjwallace@gmail.com
date: 6 Dec 2018
output:
  # html_notebook: default
  html_document:
    toc: true
    toc_depth: 4
---

# Summary

This presents the analysis of Histoplasma capsulatum start codon usage and context. This uses the H H. capsulatum G217B translation estimates from Gilmore, Voorhies, Gebhart and Sil 2017.

We decided that the 5'UTR annotations are so patchy that we don't want to pursue this data. Only about half the highly-translated genes have 5'UTRs in the annotation, and there are many contigs and plenty of missing genes including 6 ribosomal proteins.

### Load Packages

```{r setup,message=FALSE,echo=FALSE,cache=FALSE}
knitr::opts_chunk$set(warning=FALSE,message=FALSE,echo=FALSE,cache=TRUE,
                      results="hide",
                      fig.path="figure/HistoATGContext-",
                      cache.path="cache/HistoATGContext-")
# load common functions
source("../SharedScripts/sharedScripts.R")
# setwd("~/Repos/CryptoTranscriptome2018/ATGContextOthers/")
```


# Here we go

## Expression: RNA abundance and ribosome-protected-fragments

### Load expression data

```{r load_ribosum_Hc,results="show"}

fpkms_Hc <- read_tsv("data_in/ExpressionTranslation/Gilmore2015_GSE68705_Supplementary_File_27.txt") 

names(fpkms_Hc) <- str_replace_all(names(fpkms_Hc), c("G217B "=""," "="_"))

ribosum_Hc <- fpkms_Hc %>%
    select(Gene=predicted_gene,
           RNA_Y=Y_mRNA_FPKM,
           RNA_H=H_mRNA_FPKM,
           RPF_Y=Y_footprint_FPKM,
           RPF_H=H_footprint_FPKM) %>%
    mutate(RNA=(RNA_Y+RNA_H)/2,RPF=(RPF_Y+RPF_H)/2,)
    
ribosum_Hc %>%
    arrange(desc(RPF)) 

hiTrans_Hc <- ribosum_Hc %>%
    arrange(desc(RPF)) %>%
    head(n=360) %>%
    .$Gene

hiTrans_Hc_Y <- ribosum_Hc %>%
    arrange(desc(RPF_Y)) %>%
    head(n=360) %>%
    .$Gene

hiTrans_Hc_H <- ribosum_Hc %>%
    arrange(desc(RPF_H)) %>%
    head(n=360) %>%
    .$Gene

midTrans_Hc <- ribosum_Hc %>%
    arrange(desc(RPF)) %>%
    head(n=1437) %>%
    .$Gene

enoughRNA_Hc <- ribosum_Hc %>%
    arrange(desc(RNA)) %>%
    head(n=3600) %>%
    .$Gene
```


## ATG Context

### Load context data

```{r load_context_Hc,results="show"}
ctbl_big_Hc <- read_ATGcontext_table("data_in/Histo_allATGcontext.table.txt") %>%
    filter(nchar(aATG.context) == 24) %>%
    mutate(Gene=str_remove(Gene,"_mrna"))
ctbl_big_Hc
```

### Annotated ATGs have a Kozak consensus sequence

```{r aATG_context_Hc,fig.width=4,fig.height=1}
ggseqlogo(data=ctbl_big_Hc$aATG.context,namespace="TCAG") + 
    theme_nothing()
```

### Highly translated Annotated ATGs have a Kozak consensus sequence

That's for hiTrans_Hc, the top 5% (256) translated genes by RPF TPM.

```{r a_hi_context_Hc,fig.width=4,fig.height=1}
ggseqlogo(data=filter(ctbl_big_Hc,Gene %in% hiTrans_Hc)$aATG.context,
                      namespace="TCAG") + 
    theme_nothing()
```

#### Consensus is more visible on genes with 5'UTR annotation.

```{r a_hi_context_split_Hc,dependson="load_context_Hc",fig.width=4,fig.height=1}
nannotated = ctbl_big_Hc %>%
              filter(aATG.pos > 1,Gene %in% hiTrans_Hc) %>%
    nrow

nmissing = ctbl_big_Hc %>%
              filter(aATG.pos == 1,Gene %in% hiTrans_Hc) %>%
    nrow

ggseqlogo(data=ctbl_big_Hc %>%
              filter(aATG.pos > 1,Gene %in% hiTrans_Hc) %>%
              .$aATG.context,
          namespace="TCAG") +
    theme_nothing() +
    annotate(geom="text",x=22,y=1.2,
             label=paste("5' UTR\nannotated\nn =",nannotated))

ggseqlogo(data=ctbl_big_Hc %>%
              filter(aATG.pos==1,Gene %in% hiTrans_Hc) %>%
              .$aATG.context,
          namespace="TCAG") +
    theme_nothing() +
    annotate(geom="text",x=22,y=1.2,
             label=paste("5' UTR\nmissing\nn =",nmissing))
```


### Cytoplasmic Ribosome Annotated ATGs have a Kozak consensus sequence

```{r cytoribo_context_Hc,dependson="load_context_Hc",fig.width=4,fig.height=1}
cytoribolist_Hc <- read_tsv("data_in/Histo_CytoRiboList.txt",
                        comment="#") %>%
    .$GENE_ID %>%
    str_remove("_mrna")

ggseqlogo(data=filter(ctbl_big_Hc,Gene %in% cytoribolist_Hc)$aATG.context,
                      namespace="TCAG") +
    theme_nothing()
```

#### Consensus is more visible on genes with 5'UTR annotation.


```{r cytoribo_context_split_Hc,dependson="load_context_Hc",fig.width=4,fig.height=1}
nannotated = ctbl_big_Hc %>%
              filter(aATG.pos > 1,Gene %in% cytoribolist_Hc) %>%
    nrow

nmissing = ctbl_big_Hc %>%
              filter(aATG.pos == 1,Gene %in% cytoribolist_Hc) %>%
    nrow

ggseqlogo(data=ctbl_big_Hc %>%
              filter(aATG.pos > 1,Gene %in% cytoribolist_Hc) %>%
              .$aATG.context,
          namespace="TCAG") +
    theme_nothing() +
    annotate(geom="text",x=22,y=1.2,
             label=paste("5' UTR\nannotated\nn =",nannotated))

ggseqlogo(data=ctbl_big_Hc %>%
              filter(aATG.pos==1,Gene %in% cytoribolist_Hc) %>%
              .$aATG.context,
          namespace="TCAG") +
    theme_nothing() +
    annotate(geom="text",x=22,y=1.2,
             label=paste("5' UTR\nmissing\nn =",nmissing))
```


### Upstream ATGs don't have a consensus

First upstream ATG

```{r u1_context_Hc,fig.width=4,fig.height=1}
ggseqlogo(data=filter(ctbl_big_Hc,nchar(u1.context) ==24)$u1.context,
                      namespace="TCAG") + 
    theme_nothing()
```


### Downstream ATGs don't have a consensus

First downstream ATG

```{r d1_context_Hc,fig.width=4,fig.height=1}
ggseqlogo(data=filter(ctbl_big_Hc,nchar(d1.context) ==24)$d1.context,
                      namespace="TCAG") + 
    theme_nothing()
```

### Downstream ATGs in frame and highly translated don't have a consensus

Except for 3rd-codon-position bias.

```{r d1_hi_frame0_context_Hc,fig.width=4,fig.height=1}
ggseqlogo(data=filter(ctbl_big_Hc,
                      nchar(d1.context) == 24,
                      d1.frame==0,
                      Gene %in% hiTrans_Hc)$d1.context,
                      namespace="TCAG") + 
    theme_nothing()
```

## Calculate Information content and scores of consensus motif

### Calculate a wide and a narrow consensus sequence

Calculate motif score against the position weight matrix (pwm) for both **narrow** (-5 from ATG through to ATG) and **wide** (-9 from ATG to +3) kozak consensus motif. These motifs are taken from the top 5% highly translated genes.

```{r kozak_consensus_Hc,fig.width=4,fig.height=1}
kozak_w_PFM_Hc <- filter(ctbl_big_Hc,Gene %in% hiTrans_Hc) %>%
    .$aATG.context %>%
    str_sub(start=4L,end=18L) %>%
    str_to_upper() %>%
    consensusMatrix() 

kozak_w_PWM_Hc <- PWM(kozak_w_PFM_Hc)
kozak_n_PWM_Hc <- kozak_w_PFM_Hc[,5:12] %>% PWM()
```


```{r write_PFM_Hc, dependson="calc_scores_Hc",results="show"}
cat(
    "# PFM_hiTrans_Hc.txt
# Position Frequency Matrix for aATGs of 256 highest-translated genes from Hc
# This is of the wide ATG context NNNNNNNNNATGNNN
# Column is position, Row is nt count in order: ACGT.
#
# Edward Wallace, June 2018
",
file="data_out/PFM_hiTrans_Hc.txt")
kozak_w_PFM_Hc %>%
    as.tibble() %>%
    write_tsv("data_out/PFM_hiTrans_Hc.txt",
              append = TRUE,col_names=FALSE)
```

### Estimate the information content 

Using the sequence logo, details on https://en.wikipedia.org/wiki/Sequence_logo

```{r kozak_inf_Hc,dependson=c("kozak_consensus_Hc","cytoribo_context_Hc"),fig.width=4,fig.height=1,results="show"}
inf_content_narrow <- 
    tribble(
        ~Genes, ~ATG, ~Width, ~Infon,
        "All", "aATG", "narrow", 
        ctbl_big_Hc %>%
            .$aATG.context %>%
            infonfromseqs(sstart=8L,send=12L),
        "HiTrans", "aATG", "narrow", 
        ctbl_big_Hc %>%
            filter(Gene %in% hiTrans_Hc) %>% 
            .$aATG.context %>%
            infonfromseqs(sstart=8L,send=12L),
        "CytoRibo", "aATG", "narrow",
        ctbl_big_Hc %>%
            filter(Gene %in% cytoribolist_Hc) %>%
            .$aATG.context %>%
            infonfromseqs(sstart=8L,send=12L),
        "All", "d1ATG", "narrow", 
        ctbl_big_Hc %>%
            .$d1.context %>%
            na.omit() %>%
            infonfromseqs(sstart=8L,send=12L),
        "HiTrans", "d1ATG", "narrow", 
        ctbl_big_Hc %>%
            filter(Gene %in% hiTrans_Hc) %>% 
            .$d1.context %>%
            na.omit() %>%
            infonfromseqs(sstart=8L,send=12L),
        "CytoRibo", "d1ATG", "narrow",
        ctbl_big_Hc %>%
            filter(Gene %in% cytoribolist_Hc) %>%
            .$d1.context %>%
            na.omit() %>%
            infonfromseqs(sstart=8L,send=12L)
    )

write_tsv(inf_content_narrow %>%
              mutate_if(is.numeric,round3),
          "data_out/inf_content_narrow_Hc.txt")
inf_content_narrow
```

Information content in bits of highly-translated consensus (excluding 6 bits from ATG), **narrow** is `r infontot(kozak_w_PFM_Hc[,5:9]) %>% round(2)`, of **wide** is `r infontot(kozak_w_PFM_Hc[,-(10:12)]) %>% round(2)`.

### Calculate scores of aATG, dATG, uATG against Kozak consensus

```{r calc_scores_Hc, dependson="kozak_consensus_Hc"}
scores_Hc <- 
    ctbl_big_Hc %>%
    transmute(Gene,
              aATG.scorekn = PWMscoren(str_to_upper(aATG.context),kozak_n_PWM_Hc),
              d1.scorekn   = PWMscoren(d1.context,kozak_n_PWM_Hc),
              u1.scorekn   = PWMscoren(u1.context,kozak_n_PWM_Hc),
              NULL
    ) %>%
    mutate(d1vsan = d1.scorekn - aATG.scorekn,
           u1vsan = u1.scorekn - aATG.scorekn,
           NULL) 

# ribotbl_scoresenough_Hc <-
#     ribosum_Hc %>%
#     filter(Gene %in% enoughRNA_Hc) %>%
#     # left_join(ribotbl_Hc,by="Gene") %>% 
#     left_join(scores_Hc,by="Gene")

```

We calculate scores using Biostrings::PWMscoreStartingAt.

The best description I could find of this method is: https://support.bioconductor.org/p/61520/

It is just the sum of the matrix product of the PWM with the sequence.


Write scores to file *scores_kozak_Hc.txt*.

```{r write_scores_Hc, dependson="calc_scores_Hc",results="show"}
scores_Hc
cat(
    "# scores_kozak_Hc.txt
# Scores of ATG context against Kozak sequence, H. capsulatum G217B
# Kozak sequence derived from 256 highest-translated genes by RPF
#
# Gene: Hc systematic gene name
# aATG.scorekn: score of annotated ATG against narrow Kozak sequence (NNNNNATG)
# d1.scorekn: score of 1st downstream ATG against narrow
# xx.scorekw: analogous scores against wide Kozak sequence (NNNNNNNNNATGNNN)
#
# Edward Wallace, June 2018
",
file="data_out/scores_kozak_Hc.txt")
scores_Hc %>%
    mutate_if(is.numeric,round3) %>%
    write_tsv("data_out/scores_kozak_Hc.txt",
              append = TRUE,col_names=TRUE)
```

### Plot against narrow consensus (-5 to ATG)

```{r plot_scores_n_Hc, dependson="calc_scores_Hc", fig.width=5,fig.height=1.8}

sbandwidthn = 0.025

ggplot(data=scores_Hc) +
    geom_density(aes(x=aATG.scorekn,colour="aATG"),
                 kernel="rectangular",bw=sbandwidthn) +
    geom_density(aes(x=d1.scorekn,colour="dATG"),
                 kernel="rectangular",bw=sbandwidthn) +
    geom_density(aes(x=u1.scorekn,colour="uATG"),
                kernel="rectangular",bw=sbandwidthn) +
    geom_density(data=filter(scores_Hc,Gene %in% hiTrans_Hc),
                 aes(x=aATG.scorekn,colour="aATG, top 5%"),
                 kernel="rectangular",bw=sbandwidthn) +
    scale_colour_manual(values=c("aATG"="dodgerblue",
                                 "aATG, top 5%"="darkblue",
                                 "uATG"="red",
                                 "dATG"="green3") ) +
    labs(x="ATG Kozak score, Hc") +
    theme(axis.line.y=element_blank(),axis.ticks.y=element_blank(),
          axis.text.y=element_blank(),axis.title.y=element_blank(),
          legend.title=element_blank())
```

## Compare aATG and dATG context by gene

### Most dATG scores are less than aATG scores

```{r dvsaATG_scoresdens_Hc, dependson="calc_scores_Hc", fig.width=3.5,fig.height=1.8}

ggplot(data=scores_Hc) +
    geom_vline(xintercept=0,size=0.3) +
    geom_density(aes(x=d1vsan,colour="narrow"),kernel="rectangular") +
    # geom_density(aes(x=d1vsaw,colour="wide"),kernel="rectangular")  +
    labs(x="difference in score, dATG vs aATG",
         colour="context") +
    theme(axis.line.y=element_blank(),axis.ticks.y=element_blank(),
          axis.text.y=element_blank(),axis.title.y=element_blank(),
          legend.position=c(0.8,0.8))
```

### For highly translated genes, most dATG scores are much less than aATG

```{r dvsaATG_scoresn_Hc, dependson="calc_scores_Hc", fig.width=3.5,fig.height=3.5}
highdiffn_dvsaATG_Hc <- scores_Hc %>%
    arrange(desc(d1vsan)) %>%
    head(n=256) %>%
    select(Gene,aATG.scorekn,d1.scorekn)

ggplot(data=scores_Hc %>% filter(!is.na(d1.scorekn)),
       aes(x=aATG.scorekn,y=d1.scorekn)) +
    geom_diagline() +
    geom_point(size=0.5,colour="grey50") +
    geom_point(data=highdiffn_dvsaATG_Hc,
               colour="red",size=1) +
    geom_point(data=scores_Hc %>% 
                   filter(Gene %in% hiTrans_Hc),
               colour="blue",size=1) +
    geom_point(data=highdiffn_dvsaATG_Hc %>% 
                   filter(Gene %in% hiTrans_Hc),
               colour="purple4",size=1.3) +
    labs(x="aATG score, narrow",
         y="dATG score, narrow")
```

Red: high dATG vs aATG **Kozak** score.
Blue: highly translated.

(Purple: both. None of the red genes are highly translated.)

### Small negative correlation between dATG and aATG score

R = `r with(scores_Hc, cor(aATG.scorekn,d1.scorekn,use="pairwise.complete.obs")) %>% round3`

## Genes with unusual dATG vs aATG narrow score

Those genes are in this list:

```{r highdiffn_dvsaATG_Hc,dependson="dvsaATG_scoresn_Hc",results="show"}
highdiffn_dvsaATG_Hc
```

Some of these are highly translated (top 5%)

```{r highdiffn_dvsaATG_hiTrans_Hc,dependson="dvsaATG_scoresn_Hc",results="show"}
highdiffn_dvsaATG_Hc %>% 
                   filter(Gene %in% hiTrans_Hc) 
```


### dATG in frame with ATG

Files with high difference in narrow score, filtered for reasonable amounts of RNA, in frame. Saved to *dvsaATG_highdiffn_inframe_Hc.txt*.

```{r highdiffn_dvsaATG_inframe_Hc,dependson="dvsaATG_scoresn_Hc",results="show"}
highdiffn_dvsaATG_enoughinframe_Hc <- 
    highdiffn_dvsaATG_Hc %>%
    left_join( ctbl_big_Hc %>% select(Gene,d1.frame) ) %>%
    filter(Gene %in% enoughRNA_Hc, d1.frame==0) %>%
    select(Gene,aATG.scorekn,d1.scorekn)

highdiffn_dvsaATG_enoughinframe_Hc

cat(
    "# dvsaATG_highdiffn_inframe_Hc.txt
# Genes with in-frame high-score dATGs
# In H. capsulatum G217B:
#   - in top 5% by difference, aATG.scorekn - d1.scorekn
#   - in top 50% by RNA abundance
#   - dATG is in frame with aATG
#
# Gene: systematic gene name
# aATG.scorekn: annotated ATG score against narrow Kozak consensus sequence, strain xx
# d1.scorekn: 1st downstream ATG score against narrow Kozak consensus sequence, strain xx
#
# Edward Wallace, Dec 2018
",
file="data_out/dvsaATG_highdiffn_inframe_Hc.txt")
highdiffn_dvsaATG_enoughinframe_Hc %>%
    mutate_if(is.numeric,round3) %>%
    write_tsv("data_out/dvsaATG_highdiffn_inframe_Hc.txt",append = TRUE,col_names=TRUE)
```


### dATG out of frame with ATG

Files with high difference in narrow score, filtered for reasonable amounts of RNA, out of frame. Saved to *dvsaATG_highdiffn_outframe_Hc.txt*.


```{r highdiffn_dvsaATG_outframe_Hc,dependson="dvsaATG_scoresn_Hc",results="show"}
highdiffn_dvsaATG_enoughoutframe_Hc <- 
    highdiffn_dvsaATG_Hc %>%
    left_join( ctbl_big_Hc %>% select(Gene,d1.frame) ) %>%
    filter(Gene %in% enoughRNA_Hc, d1.frame!=0) %>%
    select(Gene,aATG.scorekn,d1.scorekn)

highdiffn_dvsaATG_enoughoutframe_Hc

cat(
    "# dvsaATG_highdiffn_outframe_Hc.txt
# Genes with in-frame high-score dATGs
# In H. capsulatum G217B:
#   - in top 5% by difference, aATG.scorekn - d1.scorekn
#   - in top 50% by RNA abundance
#   - dATG is out-of-frame with aATG
#
# Gene: systematic gene name
# aATG.scorekn: annotated ATG score against narrow Kozak consensus sequence, strain xx
# d1.scorekn: 1st downstream ATG score against narrow Kozak consensus sequence, strain xx
#
# Edward Wallace, Dec 2018
",
file="data_out/dvsaATG_highdiffn_outframe_Hc.txt")
highdiffn_dvsaATG_enoughoutframe_Hc %>%
    mutate_if(is.numeric,round3) %>%
    write_tsv("data_out/dvsaATG_highdiffn_outframe_Hc.txt",append = TRUE,col_names=TRUE)
```


## Compare score difference to localization predictions


### Load predictions from mitofates

In input file *Histo_mitofates.txt*.

```{r load_mitofates_Hc}
mitofates_Hc <- read_mitofates("data_in/Histo_mitofates.txt") %>%
    mutate(Gene=str_remove(Gene,"_mrna"))

mitocounts_Hc <- 
    mitofates_Hc %>% 
    group_by(Pred_preseq) %>% 
    count() 
mitobreaks_Hc <- mitocounts_Hc %>%
    mutate(label=paste0(Pred_preseq," (n = ",n,")")) %>%
    .$label %>%
    set_names(mitocounts_Hc$Pred_preseq)

mitopredlist_Hc <- mitofates_Hc %>%
    filter(Pred_preseq =="Yes") %>%
    .$Gene
```


### Hc Genes with high dATG vs aATG score *are* enriched in mitochondrial presequences

```{r dvsaATG_scoresdiffn_mitofates_Hc, dependson=c("calc_scores_Hc","load_mitofates_Hc"), fig.width=5,fig.height=1.8}

ggplot(data=scores_Hc %>% 
           filter(!is.na(d1.scorekn)) %>%
           left_join( mitofates_Hc %>% 
                          select(Gene,Prob_preseq,Pred_preseq)
                      ) ,
       aes(x=d1.scorekn-aATG.scorekn,colour=Pred_preseq)) +
    geom_vline(xintercept=0,size=0.3) +
    geom_density(kernel="rectangular",bw=0.025) +
    scale_colour_manual(values=c("Yes"="magenta","No"="grey50"),
                        labels=mitobreaks_Hc)  + 
    labs(x="Kozak score, difference dATG - aATG", colour="Mito. pred") +
    theme(axis.line.y=element_blank(),axis.ticks.y=element_blank(),
          axis.text.y=element_blank(),axis.title.y=element_blank())
```

### Hc mito-localized genes also do not have a distinctive aATG context

```{r aATG_motif_mitofates_Hc, dependson=c("calc_scores_Hc","load_mitofates_Hc"), fig.width=4,fig.height=1}

ggseqlogo(data=ctbl_big_Hc %>%
              filter(Gene %in% mitopredlist_Hc) %>%
              .$aATG.context,
          namespace="TCAG")  + 
    theme_nothing()

```

## Genes with unusual dATG vs aATG narrow score AND predicted mito loc

Those genes are in this list:

```{r highdiffn_dvsaATG_mitopred_Hc,dependson="dvsaATG_scoresn_Hc",results="show"}
highdiffn_dvsaATG_Hc %>%
    left_join( ctbl_big_Hc %>% select(Gene, d1.frame,d1.posATG) ) %>%
    left_join( ribosum_Hc %>% select(Gene,RPF)) %>%
    filter(Gene %in% mitopredlist_Hc) 
```

### less strong biases, but in frame dATG

```{r highdiffn_dvsaATG_mitopred_inframe_Hc,dependson="dvsaATG_scoresn_Hc",results="show"}
scores_Hc %>%
    arrange(desc(d1vsan)) %>%
    select(Gene,aATG.scorekn,d1.scorekn) %>%
    inner_join( ctbl_big_Hc %>% 
                   filter(d1.frame==0) %>% 
                   select(Gene,d1.posATG),
               by="Gene" ) %>%
    left_join( ribosum_Hc  %>% select(Gene,RPF) ) %>%
    filter(Gene %in% mitopredlist_Hc) %>%
    print(n=20)
```

<a href="#top">Back to table of contents</a>

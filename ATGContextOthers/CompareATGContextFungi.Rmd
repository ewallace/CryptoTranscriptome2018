---
title: "Comparisons between fungi, information content of ATG context"
author: Edward Wallace, ewjwallace@gmail.com
date: 12 Oct 2018
output:
  # html_notebook: default
  html_document:
    toc: true
    toc_depth: 4
---

# Summary

This summarizes relationships of ATG context between fungi. It relies on data output generated from the files *SPECIESNAME*ATGContext.Rmd
    
### Load Packages

```{r setup,message=FALSE,echo=FALSE,cache=FALSE}
knitr::opts_chunk$set(warning=FALSE,message=FALSE,echo=FALSE,cache=TRUE,
                      results="hide",
                      fig.path="figure/CompareATGContext-",
                      cache.path="cache/CompareATGContext-")
# load common functions
source("../SharedScripts/sharedScripts.R")
# setwd("~/Repos/CryptoTranscriptome2018/ATGContextOthers/")
```

### Load data

```{r load_infon}
Orglevels <- c("Cn","Cd","Nc","Sp","Ca","Sc")
# infon_Ca_zero <- tibble(Genes="CytoRibo",ATG="aATG",Infon=NA,Organism="Ca")

infon_tbl <- bind_rows(
    read_tsv("data_out/inf_content_narrow_Sc.txt") %>% 
        mutate(Organism="Sc"),
    read_tsv("data_out/inf_content_narrow_Ca.txt") %>% 
        mutate(Organism="Ca"),
    read_tsv("data_out/inf_content_narrow_Nc.txt") %>% 
        mutate(Organism="Nc"),
    read_tsv("data_out/inf_content_narrow_Sp.txt") %>% 
        mutate(Organism="Sp"),
    read_tsv("../ATGContext/data_out/inf_content_narrow_H99.txt") %>% 
        mutate(Organism="Cn"),
    read_tsv("../ATGContext/data_out/inf_content_narrow_JEC21.txt") %>% 
        mutate(Organism="Cd")
) %>%
    mutate(Genes=factor(Genes, levels=c("All","HiTrans","CytoRibo")),
           Organism=factor(Organism,levels=Orglevels)
    )

infon_tbl
```

## Inf content summaries

### Inf content narrow by organism and gene list

```{r inf_content,dependson="load_infon",fig.height=3,fig.width=4}
ggplot(data = infon_tbl %>% filter(ATG=="aATG"),
       aes(x=Organism,y=Infon,fill=Genes)) +
    geom_col(position="dodge") +
    scale_fill_manual(values=c("All"="dodgerblue",
                               "HiTrans"="darkblue",
                               "CytoRibo"="purple")) +
    scale_y_continuous("Information content\n-4:aATG (bits)",
                       expand=c(0,0)) 
    
```

### Inf content narrow by gene list and organism

```{r inf_content_bygenes,dependson="load_infon",fig.height=3,fig.width=4}
ggplot(data = infon_tbl %>% filter(ATG=="aATG"),
       aes(x=Genes,y=Infon,fill=Organism)) +
    geom_col(position="dodge") +
    scale_fill_brewer(type = "qual",palette=2) +
    scale_y_continuous("Information content\n-4:aATG (bits)",
                       expand=c(0,0)) +
    theme(panel.grid.major.y=element_line(colour="grey90"))
    
```

## Inf content per base


```{r load_info_perbase,echo=TRUE,results="show"}

# infon_Ca_zero <- tibble(Genes="CytoRibo",ATG="aATG",Infon=NA,Organism="Ca")

infon_perbase <- bind_rows(
    read_tsv("data_out/inf_content_perbase_Sc.txt") %>% 
        mutate(Organism="Sc"),
    read_tsv("data_out/inf_content_perbase_Ca.txt") %>% 
        mutate(Organism="Ca"),
    read_tsv("data_out/inf_content_perbase_Nc.txt") %>% 
        mutate(Organism="Nc"),
    read_tsv("data_out/inf_content_perbase_Sp.txt") %>% 
        mutate(Organism="Sp"),
    read_tsv("../ATGContext/data_out/inf_content_perbase_H99.txt") %>% 
        mutate(Organism="Cn"),
    read_tsv("../ATGContext/data_out/inf_content_perbase_JEC21.txt") %>% 
        mutate(Organism="Cd")
) %>%
    mutate(Organism=factor(Organism,levels=Orglevels))

infon_perbase

infon_perbase_g <- 
    infon_perbase %>%
    gather(key = "Genes",value="Infon",-i,-Pos,-Organism) %>%
    mutate(Genes=factor(Genes, levels=c("All","HiTrans","CytoRibo")) )

infon_perbase_g
```


```{r plot_inf_perbase,dependson="load_info_perbase",fig.height=4,fig.width=3.6}
posbreaks <- c(3,9,13:15,21)
poslabels <- c("-10","-4","A","T","G","+9")
inf_limits <- c(0,2)

ggplot(data=infon_perbase_g %>%
           mutate(Genes=factor(Genes,
                               levels=c("All","HiTrans","CytoRibo"),
                               labels=c("All Annotated",
                                        "Highly Translated",
                                        "Cyto. Ribosomal Proteins")
                               )),
       aes(x=i,y=Organism,fill=Infon) ) +
    geom_tile() + 
    scale_fill_gradient(low="white",high="darkblue",limits=inf_limits) + 
    scale_x_continuous(breaks=posbreaks,labels=poslabels,expand=c(0,0),limits=c(2.5,21.5)) + 
    scale_y_discrete(expand=c(0,0),limits=rev(Orglevels)) + 
    facet_wrap(~Genes,ncol=1,scales="free_y") + 
    theme(axis.title=element_blank()) +
    labs(fill="Info'n\ncontent\n(bits)")
```

## Inf content recomputed from inf content per base

### Inf -4 to -1

```{r inf_content_bygenes4,dependson="load_info_perbase",results="show",fig.height=3,fig.width=4}
# infon_perbase

infon_tblv <- infon_perbase_g %>% 
    filter(Pos >= -4, Pos < 0) %>%
    group_by(Organism,Genes) %>%
    summarize(Infon=sum(Infon))

# infon_tblv

ggplot(data = infon_tblv,
           aes(x=Genes,y=Infon,fill=Organism)) +
    geom_col(position="dodge") +
    scale_fill_brewer(type = "qual",palette=2) +
    scale_y_continuous("Information content\n-4:aATG (bits)",
                       expand=c(0,0)) +
    theme(panel.grid.major.y=element_line(colour="grey90"))
```

### Inf -5 to -1

```{r inf_content_bygenes5,dependson="load_info_perbase",results="show",fig.height=3,fig.width=4}
# infon_perbase

infon_tblv <- infon_perbase_g %>% 
    filter(Pos >= -5, Pos <0) %>%
    group_by(Organism,Genes) %>%
    summarize(Infon=sum(Infon))

# infon_tblv

ggplot(data = infon_tblv,
           aes(x=Genes,y=Infon,fill=Organism)) +
    geom_col(position="dodge") +
    scale_fill_brewer(type = "qual",palette=2) +
    scale_y_continuous("Information content\n-5:aATG (bits)",
                       expand=c(0,0)) +
    theme(panel.grid.major.y=element_line(colour="grey90"))
```

### Inf -6 to -1

```{r inf_content_bygenes6,dependson="load_info_perbase",results="show",fig.height=3,fig.width=4}
# infon_perbase

infon_tblv <- infon_perbase_g %>% 
    filter(Pos >= -8, Pos <0) %>%
    group_by(Organism,Genes) %>%
    summarize(Infon=sum(Infon))

# infon_tblv

ggplot(data = infon_tblv,
           aes(x=Genes,y=Infon,fill=Organism)) +
    geom_col(position="dodge") +
    scale_fill_brewer(type = "qual",palette=2) +
    scale_y_continuous("Information content\n-6:aATG (bits)",
                       expand=c(0,0)) +
    theme(panel.grid.major.y=element_line(colour="grey90"))
```

### Inf -8 to -1

```{r inf_content_bygenes8,dependson="load_info_perbase",results="show",fig.height=3,fig.width=4}
# infon_perbase

infon_tblv <- infon_perbase_g %>% 
    filter(Pos >= -8, Pos <0) %>%
    group_by(Organism,Genes) %>%
    summarize(Infon=sum(Infon))

# infon_tblv

ggplot(data = infon_tblv,
           aes(x=Genes,y=Infon,fill=Organism)) +
    geom_col(position="dodge") +
    scale_fill_brewer(type = "qual",palette=2) +
    scale_y_continuous("Information content\n-8:aATG (bits)",
                       expand=c(0,0)) +
    theme(panel.grid.major.y=element_line(colour="grey90"))
```

### Inf content wide (-10 to -1 and +4 to +6)

```{r inf_content_bygenesm10,dependson="load_info_perbase",results="show",fig.height=3,fig.width=4}
# infon_perbase

infon_tblv <- infon_perbase_g %>% 
    filter( (Pos >= -10 & Pos < 0 )| Pos %in% c(4,5,6)) %>%
    group_by(Organism,Genes) %>%
    summarize(Infon=sum(Infon))

# infon_tblv

ggplot(data = infon_tblv,
           aes(x=Genes,y=Infon,fill=Organism)) +
    geom_col(position="dodge") +
    scale_fill_brewer(type = "qual",palette=2) +
    scale_y_continuous("Information content\n-10:aATG+6 (bits)",
                       expand=c(0,0)) +
    theme(panel.grid.major.y=element_line(colour="grey90"))
```

### Inf -4 to -1 AND -10 to -5, compared

Might need redoing so uses a colour not an alpha/transparency for higher bars. 

```{r inf_content_bygenesm4ANDm10to5,dependson="load_info_perbase",results="show",fig.height=3,fig.width=4}
infon_tblv10 <- infon_perbase_g %>% 
    filter(Pos >= -10, Pos < 0) %>%
    group_by(Organism,Genes) %>%
    summarize(Infon=sum(Infon))

infon_tblv4 <- infon_perbase_g %>% 
    filter(Pos >= -4, Pos < 0) %>%
    group_by(Organism,Genes) %>%
    summarize(Infon=sum(Infon))


ggplot(data=infon_tblv4,aes(x=Genes,y=Infon,fill=Organism)) +
    geom_col(data=infon_tblv10,position="dodge",alpha=0.4) +
    geom_col(position="dodge") +
    scale_fill_brewer(type = "qual",palette=2) +
    scale_y_continuous("Information content (bits)",
                       expand=c(0,0),breaks=0:6) +
    # panel_border() + 
    theme(panel.grid.major.y=element_line(colour="grey90"))
```


## Compare dATG vs aATG score, dATG frame, and mito localization

For enoughRNA in each organism


### Load data

```{r load_dvsa,results="show"}
Orglevels <- c("Cn","Cd","Nc","Sp","Ca","Sc")
# infon_Ca_zero <- tibble(Genes="CytoRibo",ATG="aATG",Infon=NA,Organism="Ca")

dvsa_tbl <- bind_rows(
    read_tsv("data_out/dvsaATG_framemitosumm_Sc.txt") %>% 
        mutate(Organism="Sc"),
    read_tsv("data_out/dvsaATG_framemitosumm_Ca.txt") %>% 
        mutate(Organism="Ca"),
    read_tsv("data_out/dvsaATG_framemitosumm_Nc.txt") %>% 
        mutate(Organism="Nc"),
    read_tsv("data_out/dvsaATG_framemitosumm_Sp.txt") %>% 
        mutate(Organism="Sp"),
    read_tsv("../ATGContext/data_out/dvsaATG_framemitosumm_H99.txt") %>% 
        mutate(Organism="Cn"),
    read_tsv("../ATGContext/data_out/dvsaATG_framemitosumm_JEC21.txt") %>% 
        mutate(Organism="Cd")
) %>%
    mutate(Organism=factor(Organism,levels=Orglevels) )

dvsa_tbl
```

### How many mito-localized in frame high-score d1ATGs?

In Cn, 40 of them.

```{r dvsa_Cn_inframehi,dependson="load_dvsa",results="show"}
dvsa_tbl %>% filter(Organism=="Cn",d1.framefac=="In",d1vsaw0p1=="d1hi"#,enoughR=="Yes"
                    )

dvsa_tbl %>% filter(Organism=="Nc",d1.framefac=="In",d1vsaw0p1=="d1hi"#,enoughR=="Yes"
                    )
```

### Proportion of dAUG vs AUG score, d1 frame, mito pre

```{r dvsaATG_framemitosumm, dependson="load_dvsa",results="show",fig.width=4.5,fig.height=3}
dvsaATG_framemitosummspread <-
    dvsa_tbl %>%
    unite(d1f_mito,d1.framefac,Pred_preseq) %>%
    spread(key=d1f_mito,value=n) %>%
    mutate(d1vsaw0p1=factor(d1vsaw0p1,
                            levels=c("d1lo","d1hi"),
                            labels=c("d1AUG low",
                                     "d1AUG high")),
           enoughR=factor(enoughR,
                          levels=c("Yes","No"),
                          labels=c("high RNA","low RNA")),
    )

dvsaATG_framemitosumm <- 
ggplot(data=dvsaATG_framemitosummspread ) +
    geom_col(aes(x=Organism,
                 y=(In_No+In_Yes)/(In_No+In_Yes+Out_No+Out_Yes),
                 fill="Yes") ) +
    geom_col(aes(x=Organism,
                 y=(In_No)/(In_No+In_Yes+Out_No+Out_Yes),
                 fill="No") ) +
    scale_fill_manual("Mito. pred.",breaks=c("Yes","No"),
                      values=c("Yes"="magenta","No"="grey50")) + 
    scale_y_continuous(breaks=c(0,1/3,2/3,1),
                       labels=c("0","1/3","2/3","1"),
                       expand=c(0,0)) +
    expand_limits(y=0.7) + 
    labs(y="dAUG prop. in frame",x="Organism") +
    # facet_wrap(~d1vsaw0p1) +
    facet_grid(enoughR~d1vsaw0p1) +
    panel_border() +
    theme(panel.grid.major.y = element_line(colour="grey90"))

plot_grid(dvsaATG_framemitosumm,labels="C")
```

```{r dvsaATG_framemitosumm_enough, dependson="dvsaATG_framemitosumm",results="show",fig.width=4.5,fig.height=3}
ggplot(data=dvsaATG_framemitosummspread %>%
           filter(enoughR=="high RNA") ) +
    geom_col(aes(x=Organism,
                 y=(In_No+In_Yes)/(In_No+In_Yes+Out_No+Out_Yes),
                 fill="Yes") ) +
    geom_col(aes(x=Organism,
                 y=(In_No)/(In_No+In_Yes+Out_No+Out_Yes),
                 fill="No") ) +
    scale_fill_manual("Mito. pred.",breaks=c("Yes","No"),
                      values=c("Yes"="magenta","No"="grey50")) + 
    scale_y_continuous(breaks=c(0,1/3,2/3,1),
                       labels=c("0","1/3","2/3","1"),
                       expand=c(0,0)) +
    labs(y="dAUG prop. in frame",x="Organism") +
    facet_wrap(~d1vsaw0p1) +
    # facet_grid(enoughR~d1vsaw0p1) +
    panel_border() +
    theme(panel.grid.major.y = element_line(colour="grey90"))
```